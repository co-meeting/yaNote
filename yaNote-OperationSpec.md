# yaNote v1.2.13 詳細動作仕様書

本仕様書は、yaNote の各機能の詳細な動作を記述しています。  
ここに記載される内容は、ノード生成・編集、接続線操作、キャンバス操作、コントロールパネルの各種機能などを対象としており、v1.2.13 の新機能も含みます。  
本仕様書の修正は、必要な箇所のみ更新してください。

---

## 1. 基本要素とキャンバス

### 1.1. 基本要素

- **ノード（情報ブロック）**  
  - ユーザーが作成するテキストブロックです。  
  - **表示モード**:  
    - **standard（標準）**: 白背景、文字色 #404040、枠線あり  
    - **text-only（テキスト専用）**: 背景・枠線・影なし、文字色 #404040  
    - **grey（グレー）**: 背景 #595959、文字色 #FFFFFF、枠線なし  
    - **red（赤）**: 背景 #BF1304、文字色 #FFFFFF、枠線なし  
    - **dotted（点線）**: 背景が薄いグレー (#f0f0f0)、枠線が点線  
  - **リンク自動変換機能**  
    - ノード内のテキストに Markdown 記法 `[リンクテキスト](URL)` が正しく記述されている場合、編集完了時に自動的に HTML の `<a>` タグに変換されます。  
    - さらに、プレーンな URL（`http://` または `https://` で始まる文字列）も自動的にリンクに変換され、URL が 30 文字を超える場合は先頭 30 文字に「...」を付加して省略表示されます。  
    - リンクは常に `target="_blank"` が付与され、新しいタブで開かれます。

- **表示レイアウトの改善**  
  - ノードの CSS に `flex-direction: column;`、`align-items: flex-start;`、`text-align: left;` を追加することで、改行や左寄せ表示が正しく反映されます。

- **初期作成の違い**  
  - **中心ノード**は、アプリ起動時に `firstNodeType`（通常 "standard"）に基づいて生成されます。  
  - **新規ノード**（キャンバスのダブルクリックで作成される場合）は、v1.2.13 では既定で **dotted** タイプとなり、後からユーザーが手動で変更可能です。

### 1.2. キャンバス

- キャンバスは、広大な論理座標（例：10000×10000ピクセル）上にすべての要素を配置する領域です。  
- 初期状態では論理座標 (5000, 5000) に「中心ノード」が生成され、その他は空白状態です。  
- キャンバスのパン（移動）やズーム操作により表示領域は変化しますが、各要素の論理座標は保持されます。

---

## 2. コントロールパネル

- **位置**: 画面右上に固定表示され、常に操作可能です。  
- **主要要素**:
  - **タイトルフィールド**: ノート全体のタイトル表示・編集（シングルクリックで編集開始）。  
  - **ノード操作ボタン**: 太字切替、ノード種類変更（standard, text-only, grey, red, dotted）など。  
  - **接続線操作ボタン**: 線種・線の点線／実線切替ボタン。  
  - **新規/開く/保存ボタン**: ノードおよび接続線の状態の初期化、エクスポート／インポート機能。  
- **新機能**:  
  - ノードが選択されている状態で、キーボードの「e」キーを押すと即座に編集モードに切り替わります。

---

## 3. ノードの操作

### 3.1. ノードの生成と編集

- **生成**:  
  - キャンバスの空白部分をダブルクリックすると、指定位置に新しいノードが作成されます。  
  - **Ctrl/Cmd+Enter ショートカット**: 選択または編集中のノードの直下（約60px下）に、同じ種類の新規ノードが追加されます。
  
- **編集**:  
  - ノードをクリック、または選択状態で「e」キーを押すと編集モードに入ります。  
  - 編集中は、元の Markdown 形式のテキスト（およびプレーンな URL）がプレーンテキストとして表示され、ユーザーが自由に修正できます。  
  - 編集完了は Enter キーを2回押すか、他のノードが選択されることで自動確定され、入力内容はリンク自動変換処理を経て反映されます。

### 3.2. ノードの種類と状態

- ユーザーは、コントロールパネルやショートカット操作でノードの種類を切り替えることができます。  
- 新規ノードは、デフォルトで `defaultNodeType`（v1.2.13 では "dotted"）で生成されますが、既存ノードの種類を引き継ぐ場合もあります。

---

## 4. 接続線と分岐作成

- **接続線生成**:  
  キャンバス上でノード同士をドラッグ＆ドロップすることで接続線が生成されます。
  
- **分岐作成**:  
  ノードからドラッグすることで分岐（子ノード）を作成できます。  
  - 分岐作成時、分岐元ノードの種類に応じた接続線のスタイルが固定されます。  
    - **dotted ノードの場合**: 接続線は点線かつ矢印なしに設定。  
    - **その他の場合**: 実線かつ通常の矢印に設定されます。

---

## 5. キーボードショートカット

- **Ctrl/Cmd+Enter**:  
  選択または編集中のノードの直下に、新規ノードを追加します。

- **e キー**:  
  ノード選択時に「e」キーを押すと、そのノードが編集モードに切り替わります。  
  ※ 他のノードが選択された場合、編集中のノードは自動的に編集を終了します。

- **Shift+Enter**:  
  編集中に改行を入力可能です。

- **Ctrl/Cmd+Z / Ctrl/Cmd+Y**:  
  Undo/Redo 操作が可能です。

- **Backspace / Delete**:  
  選択したノードまたは接続線を削除します。

---

## 6. 状態管理とエクスポート／インポート

- **自動保存**:  
  各操作終了時に、ノード、接続線、キャンバスのパン・ズーム状態がローカルストレージに自動保存されます。

- **エクスポート／インポート**:  
  現在の状態を JSON 形式でエクスポート／インポートでき、ファイル名にはタイトルと日時が付与されます。  
  複数タブ間での状態同期にも対応しています。

---

## 7. PWA 対応

- **Service Worker の登録**  
  v1.2.13 では、PWA 対応のために Service Worker を利用した基本機能が実装されています。  
  この仕組みにより、オフライン状態でもアプリの一部機能が利用可能となります。  
  ※ ブラウザおよび端末の PWA 対応状況により、機能の詳細は異なる場合があります。

---

## 8. まとめ

v1.2.13 では、以下の点が新たに追加または改善されています：

- **リンク自動変換機能の強化**  
  - Markdown 記法のリンクに加え、プレーンな URL（http://, https://）も自動でリンクに変換し、長い URL は省略表示されます。

- **PWA 対応**  
  - Service Worker の登録により、オフライン環境でも基本的な利用が可能になっています。

- **既存機能の継続提供**  
  - ノードの作成・編集、接続線操作、ドラッグ＆ドロップ、Undo/Redo、エクスポート／インポートなどの操作は従来通りの動作を維持しています。

この仕様書は、ユーザーがより直感的に操作できるよう改善された点を反映しています。詳細な動作や各機能の実装に関する説明は、各種ドキュメント（help.md、ChatGPT_DevGuide.md 等）も合わせてご参照ください。

---

以上が、v1.2.13 の yaNote-OperationSpec.md となります。何かご質問や修正点があればお知らせください。