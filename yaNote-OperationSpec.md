```markdown
# yaNote v1.2.8 詳細動作仕様書

- 本仕様書は、現状実装されている機能のみを対象とし、追加未実装の機能は含みません。
- yaNote は、ノードと線（接続線・独立線）を同等の基本要素として扱い、それぞれ独立に生成・編集・移動できることを前提としています。
- 本仕様書の修正は、必要な箇所のみ更新してください。

---

## 1. 基本要素とキャンバス

### 1.1. 基本要素

- **ノード（情報ブロック）**
  - テキストを保持する要素。ユーザーはノードを作成後、編集・移動・削除が可能です。
  - ノードには **2種類** があり、**standard（標準）** と **text-only（テキストのみ）** で表示が切り替えられます。  
    - 新規作成時はデフォルトで standard となり、コントロールパネルから切り替えが可能です。
  - ノードは、太字の設定が個別に可能です。
  - **複数行テキスト** の入力および表示に対応しており、Shift+Enter による改行が可能です。

- **線（独立線・接続線）**
  - ノード間の関連性を示すために利用されます。背景上での生成も可能で、端点の接続は後から変更できます。
  - 選択時は、両端に操作用ハンドルが表示され、端点のドラッグ操作で接続先を変更できます。
  - 線には **4種類** があり、**standard（標準矢印）**、**no-arrow（矢印なし）**、**reverse-arrow（逆矢印）**、**both-arrow（両方向矢印）** が選択可能です。  
    - 新規作成時はデフォルトで standard が適用され、コントロールパネルから変更できます。
  - 線の表示スタイルとして **実線** と **点線** の切り替えが可能です。  
    - デフォルトは実線であり、こちらもコントロールパネルから変更できます。

### 1.2. キャンバス

- キャンバスは、広い論理座標（例：10000×10000ピクセル）の領域で管理されます。
- **初期状態**  
  - 論理座標 (5000, 5000) に「中心ノード」が作成され、それ以外の要素は存在しません。
- パン（移動）操作により表示範囲が変化しても、ノードや線の論理座標は維持され、全ての操作が正しく機能します。
- スクロールバーは非表示で、マウスホイールやトラックパッドによるパン操作でキャンバス全体が操作可能です。

---

## 2. コントロールパネル

- **表示位置:**  
  コントロールパネルは画面右上に固定表示され、常に操作可能です。  
  ※ CSS の `position: fixed` 指定により、canvas の transform 影響を受けません。

- **各ボタンおよびタイトルフィールドの機能:**

  - **タイトルフィールド**  
    - コントロールパネルの左側に配置され、現在のノートタイトルを表示します。  
    - 初回は、中心ノードの編集完了時に自動反映されます。その後はユーザーが手動で変更可能です。  
    - 編集状態ではテキストが左寄せ、編集確定後は右寄せに自動切替され、入力内容に合わせて幅が自動調整されます。  
    - 入力が空の場合は「無題」と表示され、エクスポート時のファイル名に反映されます。

  - **太字ボタン（`B`）**  
    - 選択中のノードのテキストを太字に切り替えます。  
    - 複数ノード選択時は全体が太字か通常かで一括変更可能です。  
    - ノード未選択時は無効になります。

  - **ノード種類変更ボタン（`◻︎`）**  
    - 選択中のノードの種類（standard と text-only）を切り替えます。  
    - text-only ノードは背景・枠線・影が排除され、シンプルな表示となります。  
    - 選択がない場合は、新規作成時のデフォルト種類が変更されます。

  - **線種変更ボタン（`→`, `—`, `←`, `↔`）**  
    - 選択中の線の種類を切り替えます。  
    - 線種は「standard」→「no-arrow」→「reverse-arrow」→「both-arrow」→「standard」の順にローテーションします。  
    - 選択がない場合は、デフォルト線種が変更されます。

  - **点線・実線切替ボタン（`—`, `‥`）**  
    - 選択中の線の表示スタイルを、実線と点線で切り替えます。  
    - ボタンの表記のみで状態を示し、色によるハイライトは使用しません。  
    - 選択がない場合は、デフォルトの線スタイルが変更されます。

  - **初期状態に戻すボタン（`新規`）**  
    - ローカルストレージのデータをクリアし、キャンバスを初期状態に戻します。  
    - 初期状態では「中心ノード」のみが生成されます。

  - **インポートボタン（`開く`）**  
    - 保存済みの JSON ファイルを選択してアップロードすると、キャンバスの状態が復元されます。

  - **エクスポートボタン（`保存`）**  
    - 現在の状態を JSON 形式のファイルとしてダウンロードします。  
    - ファイル名は、タイトルフィールドの内容（空なら「無題」）を先頭に、日付と時刻が付与されます。

---

## 3. ノードの操作

### 3.1. ノードの生成

- **背景上での生成**  
  キャンバスの空白部分を **ダブルクリック** すると、その位置に新規ノードが生成されます。  
  ノード生成直後は編集モードに入り、テキスト入力が可能です。

### 3.2. ノードの編集

- **編集開始**  
  ノードを **ダブルクリック** すると、編集モードになり、背景色が薄い黄色に変化します。
  
- **編集終了**  
  - **Enter キー** を押す（※ Enter キーは2回押すか、フォーカス外に移動）と編集が確定され、通常表示に戻ります。
  - 編集中に **Shift+Enter** を押すことで改行が挿入され、ノードの高さが自動調整されます。
  - ノードのテキストが空の場合、ノードは削除され、関連する線は固定座標で保持または削除されます。

- **ノード種類と太字設定**  
  ノードの種類はコントロールパネルの「◻︎」ボタンで切り替え可能です。  
  また、コントロールパネルの「B」ボタンで選択したノードのテキストを太字に変更できます。

---

## 4. 線の操作

### 4.1. 線の生成

- **背景上での生成**  
  キャンバスの空白部分を **ダブルクリック** し、2回目のクリック時にマウスボタンを押したままドラッグすると、新規線の作成が開始されます。

- **ノード上での生成（ブランチ作成モード）**  
  ノードを **ダブルクリック** し、2回目のクリック時にドラッグすると、そのノードから線が生成されます。

- **接続操作**  
  生成された線は、両端に表示されるハンドルをドラッグすることで接続先を変更できます。  
  線の種類および表示スタイルは、最後に使用した設定が自動適用され、コントロールパネルから切り替え可能です。

### 4.2. 線種および線表示スタイルの変更

- **線種の変更**  
  コントロールパネルの線種変更ボタンをクリックすると、選択中の線（またはデフォルト設定）の線種が「standard」、「no-arrow」、「reverse-arrow」、「both-arrow」の順にローテーションします。

- **線表示スタイルの切替**  
  コントロールパネルの点線・実線切替ボタンをクリックすると、線の表示スタイルが実線と点線で切り替わります。  
  ボタンはそのシンボル（"—" または "‥"）で状態を示します。

---

## 5. グループ選択と一括操作

- **ラバーバンド選択**  
  空白部分を左クリック＋ドラッグすると、矩形が表示され、その範囲内または交差するノードおよび線が一括で選択されます。

- **グループ移動**  
  選択したノードや線は、グループとして移動させることができ、相対位置が保持されます。

- **一括編集**  
  複数選択した場合、ノードの太字設定や種類変更、線の線種・表示スタイルの切替を一括で実行できます。

- **削除**  
  選択状態のノードまたは線は、Delete または BackSpace キーで削除できます。

---

## 6. キャンバス操作（パン移動）

- **右クリック＋ドラッグ**  
  右クリックでドラッグすると、キャンバス全体がパン移動します。

- **マウスホイールとシフトキー**  
  - マウスホイールを回すと縦方向に移動  
  - Shift キーを押しながらホイール回転で横方向に移動

- **トラックパッド操作**  
  二本指スクロールで任意方向へのパン移動が可能です。

---

## 7. 状態管理

- **自動保存**  
  各操作の完了時に、現在の状態（ノード、線、各種設定、キャンバスのパン・ズーム状態）がローカルストレージに自動保存されます。

- **多タブ同期**  
  複数タブ間で状態が更新された場合、最新状態が自動的に同期されます。

- **エクスポート／インポート**  
  現在の状態を JSON 形式でエクスポートでき、インポートすることで以前の状態を復元可能です。  
  エクスポート時のファイル名は、タイトルフィールドの内容（空の場合は「無題」）と日付・時刻で生成されます。

---

## 8. Undo／Redo 操作

- **Undo／Redo 対応**  
  すべての操作（ノード・線の生成、編集、移動、削除など）は Undo/Redo 操作の対象です。

- **ショートカットキー**  
  - Undo: Ctrl+Z (または Cmd+Z on Mac)  
  - Redo: Ctrl+Y (または Cmd+Y on Mac)

---

## 9. タイトルフィールドの新機能

- **概要:**  
  タイトルフィールドは、ユーザーがノート全体のタイトルを設定できる新機能です。  
  タイトルはエクスポート時のファイル名に反映されます。

- **動作:**  
  - **初回自動反映:**  
    中心ノード（ID==1）の初回編集完了時に、その内容がタイトルフィールドに自動で反映されます。  
  - **編集:**  
    タイトルフィールドをダブルクリックすると編集可能になり、編集中はテキストが左寄せで表示されます。  
    Enter キー（IME変換中は除く）で編集確定し、確定後はテキストが右寄せに切り替わり、入力内容全体が表示されるように幅が自動調整されます。  
  - **デフォルト:**  
    入力が空の場合は自動的に「無題」となり、エクスポート時にファイル名に使用されます。

---

## 10. マウス操作仕様一覧

| **操作の種類**              | **対象**       | **開始条件**                                                  | **結果**                                               |
| --------------------------- | -------------- | ------------------------------------------------------------- | ------------------------------------------------------ |
| クリック（シングル）        | ノード         | 左クリック                                                    | ノードを選択                                          |
| クリック（シングル）        | 線             | 左クリック                                                    | 線を選択（端点ハンドルを表示）                         |
| クリック（シングル）        | 空白           | 左クリック                                                    | 選択解除                                             |
| ダブルクリック               | ノード         | 2回目のクリック時にマウスを動かさずに離す                        | 編集モードに入り、テキスト編集可能                      |
| ダブルクリック               | 空白           | 2回目のクリック時にマウスを動かさずに離す                        | 新規ノードが生成される                                 |
| ダブルクリック → 移動        | ノード         | 2回目のクリックの状態でマウスボタンを押しながら一定距離（約10px以上）移動 | ブランチ作成モードで、ノードから線が生成される         |
| ダブルクリック → 移動        | 空白           | 2回目のクリックの状態でマウスボタンを押しながら一定距離（約10px以上）移動 | 新規線が生成される                                     |
| ドラッグ（選択なし）        | ノード         | 左クリック＋ドラッグ（一定距離以上）                           | ノードが移動する                                     |
| ドラッグ（選択なし）        | 線の端点       | 左クリック＋ドラッグ                                            | 線の端点が移動し、接続先を変更可能                     |
| ドラッグ（選択なし）        | 空白           | 左クリック＋ドラッグ                                            | ラバーバンド選択が開始される                           |
| ドラッグ（選択あり）        | ノード         | 選択中のノードをドラッグ                                        | 選択中のノードがグループとして移動される              |
| ドラッグ（選択あり）        | 線の端点       | 選択中の線の端点をドラッグ                                       | 選択中の線の端点がグループとして移動される             |
| 右クリック → ドラッグ       | キャンバス     | 右クリック＋ドラッグ                                             | キャンバスがパン（移動）される                        |
| マウスホイール              | キャンバス     | ホイール回転                                                   | キャンバスが縦方向にパン移動する                      |
| Shiftキー+マウスホイール    | キャンバス     | Shift キー＋ホイール回転                                          | キャンバスが横方向にパン移動する                      |
| トラックパッド二本指スクロール | キャンバス   | 二本指でスクロール操作                                           | 任意方向へのパン移動が可能                           |
| BackSpace/ Delete         | 選択状態       | ノードまたは線が選択された状態で押下                             | 選択された要素が削除される                           |

---

この仕様書は、yaNote v1.2.8 の各機能と操作方法、及び新たに追加されたタイトルフィールド機能の動作について詳細に説明しています。  
ユーザーは、直感的なドラッグ＆ドロップ操作や各種キーボードショートカットを利用して、柔軟かつ効率的に情報を整理することができます。
```