# yaNote v1.2.13.3 操作仕様書（2025-03-06）

本仕様書は、yaNote の現行実装に基づき、ユーザーが実際に操作できる機能のみを記述しています。未実装や検討中の機能は含まず、各操作の手順と結果を統一した粒度でまとめています。

---

## 0. 仕様書ガイドライン

- **一貫性の保持**  
  - 用語、表記、フォーマットは全体を通じて統一すること。  
  - 操作の記述は、具体的な手順と期待される結果を明確に記載する。

- **ユーザー視点の記述**  
  - 技術的な実装詳細ではなく、ユーザーが実際に行う操作とその結果に焦点を当てる。

- **更新時の明確な差分管理**  
  - 新バージョンでの変更点は明示的に記載し、旧仕様との違いを分かりやすくする。

- **詳細な操作説明**  
  - 各操作について、発動方法、手順、結果、注意点を網羅的に記述する。

- **レビュープロセスの活用**  
  - 仕様書作成後、フィードバックを取り入れ定期的に見直す。

- **バージョン管理**  
  - 仕様書自体にもバージョン番号と更新日を明記し、変更履歴を管理する。

---

## 1. キャンバスと基本要素

### 1.1. キャンバス
- **概要**:  
  論理座標 10000×10000 ピクセルの作業領域。  
  初期表示時は、画面中央（論理座標 5000, 5000）に「中心ノード」が配置されます。

- **操作**:  
  - **パン**:  
    右クリック＋ドラッグでキャンバス全体を移動します。

### 1.2. ノード
- **概要**:  
  ユーザーがテキスト情報を入力する情報ブロック。  
  生成後、編集、移動、削除が可能です。

- **種類**:  
  現在、以下の5種類が実装されています.
  - **standard（標準）**
  - **text-only（テキストのみ）**
  - **grey（グレー）**
  - **red（赤）**
  - **dotted（点線）**  
    ※ 新規生成時は「dotted」がデフォルトです。

### 1.3. 接続線
- **概要**:  
  ノード間の関連性を示すための線。  
  生成後は接続先の変更が可能です。

- **ハンドル**:  
  接続線が選択された場合、線の両端に小さな円形ハンドルが表示されます。  
  ※ ノード自体をクリックしてもハンドルは表示されません。

---

## 2. ノードの操作

### 2.1. ノード生成
- **背景上での生成**:  
  空白部分を **ダブルクリック** すると、その位置に新規ノードが生成され、即座に編集モードに入ります。

- **Ctrl/Cmd+Enter ショートカット**:  
  選択中または編集中のノードの直下に新規ノードが追加されます。  
  ※ 追加位置は、選択中ノードの高さに基づいたオフセット（例: ノード高さ＋10px）で自動算出されるため、改行等で高さが変わっても重なりません。

### 2.2. ノード編集
- **開始方法**:  
  ノードを **ダブルクリック** するか、選択状態で「e」キーを押すと編集モードに入ります。  
  編集モード中は背景色が薄い黄色に変化します。

- **終了方法**:  
  Enter キーを2回連続で押すことで編集が確定し、入力内容が自動的にリンク形式へ変換されます。  
  編集確定時、接続線も最新のノードサイズに合わせ再計算されます。  
  ※ 入力内容が空の場合、該当ノードは削除されます。

- **ブランチ作成**:  
  ノード上で **ダブルクリック** した後、2回目のクリック時にマウスボタンを押したまま、約10px以上ドラッグすると、そのノードから新規接続線（ブランチ）が生成されます。  
  - **ドラッグ先が既存ノードの場合**:  
    ドラッグを離した位置が既存ノードに重なっていれば、そのノードとの接続が確定されます。  
  - **ドラッグ先が空白の場合**:  
    自由接続線として生成され、線の両端は初回クリック位置とマウスアップ時の位置となります。

### 2.3. ノード移動・削除
- **移動**:  
  ノードを **左クリック＋ドラッグ** すると移動できます。  
  複数選択している場合はグループ移動が実施され、各ノードの相対位置が保持されます。

- **削除**:  
  選択中のノードは Backspace または Delete キーで削除され、接続している接続線も同時に削除されます。

### 2.4. 複数選択
- **Shift＋クリック**:  
  ノードを選択中に Shift キーを押しながら別のノードをクリックすることで、複数ノードの選択・選択解除が可能です。

- **ラバーバンド選択**:  
  空白部分で **左クリック＋ドラッグ** すると、矩形（ラバーバンド）が描画され、矩形内または矩形と交差するすべてのノードおよび接続線が一括で選択されます。

### 2.5. ノード種類変更
- **操作**:  
  コントロールパネルの「ノード種類変更」ボタンを押すと、現在選択中またはデフォルトのノードの種類が、実装済みの5種類（standard, text-only, grey, red, dotted）の間で切り替わります。  
- **効果**:  
  ノードの外観（背景、枠線、影、文字色）が即時更新されます。

---

## 3. 接続線の操作

### 3.1. ノード間接続
- **発動方法**:  
  対象ノード上で **ダブルクリック** した後、2回目のクリック時にマウスボタンを押し続け、一定距離（約10px以上）ドラッグすることで、接続線生成が開始されます。

- **動作詳細**:  
  1. **ドラッグ開始**:  
     - 対象ノード上でダブルクリック後、マウスボタンを押したままドラッグすると、初回クリック位置（対象ノードの基準点）が記録されます。  
  2. **仮のライン表示**:  
     - ドラッグ中は、一時的な点線が表示され、接続線生成中であることが視覚的に示されます。  
  3. **ドラッグ完了**:  
     - **既存ノードがドロップ先の場合**:  
       ドラッグを離した位置が既存ノードに重なっていれば、初回クリック位置からそのノードへの接続線が生成され、接続先が確定されます。  
     - **空白がドロップ先の場合**:  
       自由接続線として生成され、線の両端は初回クリック位置とマウスアップ時の位置となります。

- **注意点**:  
  ノード間接続は、必ずダブルクリック後のドラッグ操作で発動します。単なる左クリック＋ドラッグでは接続線は生成されません。

### 3.2. 自由接続
- **発動方法**:  
  空白部分で **ダブルクリック** または **ダブルクリック＋ドラッグ** を行うと、自由接続の生成が開始されます。

- **動作詳細**:  
  1. **ドラッグ開始**:  
     - 空白部分でダブルクリック後、2回目のクリック時にマウスボタンを押したままドラッグすると、初回クリック位置が記録されます。  
  2. **仮のライン表示**:  
     - ドラッグ中は、一時的な点線（ダッシュ）が表示され、自由接続生成中であることが示されます。  
  3. **ドラッグ完了**:  
     - **既存ノードがドロップ先の場合**:  
       マウスを離した位置が既存ノードに重なっていれば、初回クリック位置からそのノードへの接続線が生成されます。  
     - **空白がドロップ先の場合**:  
       自由接続線として生成され、端点は初回クリック位置とマウスアップ時の位置となります。  
  4. **短いドラッグの場合**:  
     - ドラッグ距離が約10px未満の場合は、新規ノード生成として扱われ、即座に編集モードに入ります。

- **注意点**:  
  自由接続は、空白部分でのダブルクリック後のドラッグ操作でのみ発動します。

### 3.3. 接続線編集
- **ハンドル操作**:  
  接続線を左クリックで選択すると、両端に表示されたハンドルを用い、左クリック＋ドラッグすることで接続線の端点の接続先を変更できます。

- **自動更新**:  
  ノードの移動、編集、またはキャンバスのパン操作に合わせ、接続線は自動的に再計算され、常に最新の状態で表示されます.

---

## 4. グループ選択
- **Shift＋クリック**:  
  複数のノードを選択する場合、Shift キーを押しながら各ノードをクリックすることで、個別に複数選択が可能です。  
  すでに選択されているノードを Shift＋クリックすると、そのノードの選択が解除されます.

- **ラバーバンド選択**:  
  空白部分で **左クリック＋ドラッグ** すると、矩形（ラバーバンド）が描画され、矩形内または矩形と交差するすべてのノードおよび接続線が一括で選択されます.

---

## 5. キャンバス操作
- **パン**:  
  右クリック＋ドラッグでキャンバス全体を移動します.

---

## 6. Undo／Redo と状態管理
- **自動保存**:  
  各操作（ノードや接続線の生成、編集、移動、削除）が完了するたびに、現在の状態が自動的に保存されます.

- **Undo／Redo**:  
  - **Undo**: Ctrl/Cmd+Z により直前の操作を取り消します.  
  - **Redo**: Ctrl/Cmd+Y により取り消された操作が再適用されます.

- **エクスポート／インポート**:  
  - **エクスポート**: 現在の状態が JSON 形式でファイル出力され、ファイル名にはタイトルと日時が自動付与されます.  
  - **インポート**: 保存済みの JSON ファイルから状態が復元され、内部履歴に追加されます.

---

## 7. コントロールパネル
- **表示位置**:  
  画面右上に常時表示され、ユーザーは各種操作をシンプルに実施できます.

- **主な機能**:
  - **新規**:  
    新規ボタンをクリックすると、現在の状態に未保存の変更がある場合、保存確認ダイアログが表示されます.  
    ユーザーが保存済みであることを確認すると、状態がクリアされ、初期状態（「中心ノード」のみ）が生成されます.
  - **保存（エクスポート）**:  
    現在の状態を JSON ファイルとして出力します.
  - **開く（インポート）**:  
    開くボタンをクリックすると、未保存の状態がある場合に保存確認ダイアログが表示されます.  
    ユーザーが保存済みであると確認した場合、JSON ファイルを選択し、状態が復元されます.
  - **ノード種類変更**:  
    選択中またはデフォルトのノードの種類を切り替えます.
  - **線種・線タイプ変更、太字切替**:  
    接続線およびノードの表示スタイルを変更し、ツールチップで操作結果がフィードバックされます.

---

## 8. PWA対応
- **概要**:  
  yaNoteは、PWA（プログレッシブウェブアプリ）としての機能を備えており、オフライン環境でも基本的な動作が可能です.

- **主な機能**:  
  - **Service Workerの登録**:  
    ブラウザにService Workerが登録され、主要なリソース（HTML、CSS、JavaScript、アイコンなど）がキャッシュされます.  
  - **オフライン対応**:  
    キャッシュされたリソースにより、インターネット接続が不安定またはオフラインの場合でも、yaNoteの基本機能を利用できます.  
  - **迅速な更新**:  
    バージョン管理されたService Workerにより、新しいバージョンがリリースされた際、skipWaiting()やclients.claim()が活用され、ユーザーのリロード操作のみで最新バージョンが反映されます.

---

## 9. ユーザー操作まとめ

| **操作**                   | **対象**               | **操作方法**                                                     | **結果**                                               |
| -------------------------- | ---------------------- | ---------------------------------------------------------------- | ------------------------------------------------------ |
| シングルクリック            | ノード                 | 左クリック                                                       | ノードが選択状態になりハイライトされる。ハンドルは表示されない.  |
| シングルクリック            | 接続線                 | 左クリック                                                       | 接続線が選択され、両端にハンドルが表示される.             |
| シングルクリック            | 空白                   | 左クリック                                                       | すべての選択が解除される.                              |
| ダブルクリック               | ノード                 | 2回目のクリック時、マウスを動かさずに離す                             | ノードが編集モードに入り、背景色が薄い黄色に変化する.       |
| ダブルクリック               | 空白                   | 2回目のクリック時、マウスを動かさずに離す                             | その位置に新規ノードが生成され、即座に編集モードに入る.      |
| ダブルクリック＋ドラッグ    | ノード                 | ノード上で2回目のクリック時、マウスボタンを押したまま約10px以上ドラッグ | ノードから新規接続線（ブランチ）が生成される.             |
| ダブルクリック＋ドラッグ    | 空白                   | 空白上で2回目のクリック時、マウスボタンを押したまま約10px以上ドラッグ | 自由接続線が生成される.                                |
| 左クリック＋ドラッグ         | ノード                 | 左クリック＋ドラッグ（一定距離以上）                                | ノードが移動し、接続線はリアルタイムで更新される.           |
| 左クリック＋ドラッグ         | 接続線のハンドル         | 接続線選択時に表示されたハンドル上で左クリック＋ドラッグ         | 接続線の端点が移動し、接続先が変更される.                 |
| 左クリック＋ドラッグ         | 空白                   | 左クリック＋ドラッグ                                               | ラバーバンドが描画され、矩形内のノード・接続線が選択される.      |
| Shift＋クリック             | ノード                 | Shiftキーを押しながらノードをクリック                             | 複数ノードの選択・選択解除が行われる.                     |
| 右クリック＋ドラッグ         | キャンバス             | 右クリック＋ドラッグ                                               | キャンバス全体が移動（パン）される.                    |
| キーボードショートカット      | 全体の操作              | Ctrl/Cmd+Enter, e, Shift+Enter, Ctrl/Cmd+Z, Ctrl/Cmd+Y, Delete        | ノード・接続線の生成、編集確定、Undo／Redo、削除などが実行される.  |

---

## 10. まとめ

yaNote v1.2.13.3 は、ユーザーが直感的に情報を整理・編集できるツールとして、以下の操作を実現しています。

- **ノード操作**:  
  - ノードは、背景上でのダブルクリックや Ctrl/Cmd+Enter ショートカットにより生成され、ダブルクリックまたは「e」キーで編集が可能です.  
  - 編集確定時には、入力内容が自動的にリンク形式に変換され、接続線も再計算されます.  
  - Shift＋クリックやラバーバンド選択により、複数ノードの選択が容易です.

- **接続線操作**:  
  - ノード間接続は、対象ノード上でのダブルクリック＋ドラッグで発動し、ドラッグ先に応じて既存ノードとの接続または自由接続線として生成されます.  
  - 自由接続は、空白部分でのダブルクリック＋ドラッグで生成され、ドラッグ先が既存ノードならそのノードと接続、空白なら自由接続線として生成されます.  
  - 接続線選択時は、両端に表示されるハンドル操作で、端点の接続先を変更できます.

- **キャンバス操作**:  
  - 右クリック＋ドラッグでキャンバス全体のパン操作が可能です.

- **Undo／Redo と状態管理**:  
  - 各操作は自動保存され、Undo／Redo により誤操作の修正が容易です.  
  - 状態は JSON 形式でエクスポート／インポートでき、外部保存・復元が可能です.

- **コントロールパネル**:  
  - 画面右上に常時表示され、ユーザーは新規、保存（エクスポート）、開く（インポート）、ノード種類変更、線種・線タイプ変更、太字切替などの操作をシンプルに実施できます.  
  - 新規および開くボタン押下時は、未保存状態の場合に保存確認ダイアログが表示され、ユーザーに保存済みかの確認を促します.

- **PWA対応**:  
  - yaNoteはPWAとして動作し、Service Workerにより主要リソースがキャッシュされ、オフライン環境でも基本機能が利用可能です.  
  - 新バージョンがリリースされた際は、skipWaiting()やclients.claim()の活用により迅速な更新が実現されます.

本仕様書は、現行実装に基づいてユーザーが実際に利用できる操作方法を明確に記述しています。今後の改善や機能拡張においても、この仕様書を基準として操作性の向上を図ります.
