# yaNote v1.2.4 詳細動作仕様書

- 本仕様書は、現状実装されている機能のみを対象とし、追加未実装の機能は含みません。
- ノードと線を同等の基本要素として扱い、それぞれ独立に生成・編集・移動が可能であることを前提とします。
- 本仕様書の修正は、必要な箇所のみ更新してください。

---

## 1. 基本要素とキャンバス

### 1.1. 基本要素

- **ノード（情報ブロック）**
  - テキストを保持する要素。
  - 生成後、編集・移動・削除が可能。
  - ノードは **2種類** あり、**standard（標準）** と **text-only（テキストのみ）** が存在します。  
    - 新規作成時はデフォルトで standard となり、コントロールパネルから切り替えが可能です。
  
- **線（独立線・接続線）**
  - ノード間の関連を示すために使用される。
  - 背景上でも生成可能で、端点の接続は後から変更できる。
  - 選択時は、両端に操作用ハンドルが表示され、端点の調整が可能です。
  - 線には **4種類** あり、**standard（標準矢印）**、**no-arrow（矢印なし）**、**reverse-arrow（逆矢印）**、**both-arrow（両方向矢印）** が存在します。
    - 新規作成時はデフォルトで standard となり、コントロールパネルから切り替えが可能です。

### 1.2. キャンバス

- キャンバスは、広い論理座標（例：10000×10000ピクセル）の領域として管理されます。
- **初期状態**では、論理座標 (5000, 5000) に「中心ノード」が生成され、それ以外の要素は存在しません。
- パン（移動）やズーム操作により表示範囲が動的に変化しても、ノードや線の論理座標は維持され、すべての操作が正しく機能します。

---

## 2. コントロールパネル

- **表示位置:** 画面右上に固定表示され、常に操作可能。
- **各ボタンの機能:**
  - **ノード種類変更ボタン（`◻︎`）**
    - 選択中のノードの種類を切り替えます。
    - 複数のノードが選択されている場合、全てが「text-only」なら「standard」に、そうでなければ「text-only」に変更します。
    - 「text-only」ノードは、背景、枠線、影が排除され、シンプルな見た目となります。
    - 接続線の描画においても、"text-only" ノードの場合、ノードの境界との交点に基づいた位置調整が行われます。

  - **線種変更ボタン（`ー`）**
    - 選択中の線の種類を切り替えます。
    - 線種は「standard」→「no-arrow」→「reverse-arrow」→「both-arrow」→「standard」の順にローテーションします。
    - 複数の線が選択されている場合、全て同じ種類なら次の種類に一括変更し、異なる種類が混在している場合は「standard」に統一します。
    - 最後に使用した線種は記憶され、新しい線を作成する際のデフォルトとして適用されます。

  - **初期状態に戻すボタン（`新規`）**
    - ローカルストレージのデータをクリアし、ページをリロードします。
    - キャンバスは初期状態に戻り、「中心ノード」のみが生成されます。

  - **インポートボタン（`開く`）**
    - 保存済みの JSON ファイルを選択してアップロードすると、キャンバスの状態が復元されます。

  - **エクスポートボタン（`保存`）**
    - 現在の状態を JSON 形式のファイルとしてダウンロードします。
    - 保存データには、ノードおよび線の情報、線種、キャンバスのパン／ズーム状態、バージョン情報が含まれます。
    - ファイル名は `"yaNote_export_YYYY-MM-DD_HH-MM-SS.json"` の形式です。

---

## 3. ノードの操作

### 3.1. ノードの生成

- **背景上での生成:**
  - 何もない場所で **ダブルクリック** すると、その位置に新規ノードが生成されます。
  - 生成されたノードは即座に **編集モード** に入り、テキスト入力が可能となります。

### 3.2. ノードの編集

- **編集開始:**
  - ノードを **ダブルクリック** すると、編集モードに入り、背景色が薄い黄色に変化します。
- **編集終了:**
  - **Enterキー** を押すと、編集が確定し、通常の表示に戻ります。
  - 連続して **Enterキーを2回押す** と、編集モードが強制終了します。
  - ノードのテキストが空の場合、ノードは削除され、関連する線は固定座標で保持または削除されます。
- **ノード種類:**
  - 新規生成ノードはデフォルトで standard ですが、コントロールパネルの「ノード種類変更」ボタンにより、standard と text-only を切り替えられます。

---

## 4. 線の操作

### 4.1. 線の生成

- **背景上での生成:**
  - 何もない場所で **ダブルクリック** し、2回目のクリック時にマウスボタンを押したまま一定距離（約10ピクセル以上）ドラッグすると、新規線の作成が開始されます。
- **ノード上での生成（ブランチ作成モード）:**
  - ノード上で **ダブルクリック** し、2回目のクリック時にマウスボタンを押したままドラッグすると、新規線が生成されます。
- **操作:**
  - 生成された線は、端点のハンドルを使って接続先を変更できます。
  - 線の種類は、最後に使用した線種が自動的に適用されます。

### 4.2. 線種の変更

- **変更方法:**
  - 線を選択し、コントロールパネルの「線種変更」ボタン（`ー`）をクリックします。
  - 複数の線を選択している場合、全て同じ種類なら次の種類にローテーションし、異なる種類が混在している場合は「standard」に統一します。
- **線種の種類:**
  - **standard（標準矢印）:** 終点に矢印がある通常の線
  - **no-arrow（矢印なし）:** 矢印がない単純な線
  - **reverse-arrow（逆矢印）:** 始点に矢印がある線（矢印の向きが反転）
  - **both-arrow（両方向矢印）:** 始点と終点の両方に矢印がある線
- **デフォルト設定:**
  - 最後に変更した線種が、新しい線を作成する際のデフォルト線種として記憶されます。
  - デフォルト線種はページをリロードしても保持されます。

---

## 5. グループ選択（ラバーバンド選択）

### 5.1. 選択の開始

- **操作:**
  - 背景の何もない場所で **左クリック＋ドラッグ** すると、矩形（ラバーバンド）が表示されます。
  - マウスボタンを離すと、矩形内または矩形と交差するノードおよび線が選択状態になります。

### 5.2. 選択中の動作

- **選択されたノード:** 枠線が青色に変化します。
- **選択された線:** 赤色に変わり、端点に操作用ハンドルが表示されます。
- **グループ移動:**
  - 選択状態のノードおよび線はグループとして移動でき、相対的な位置関係が保持されます。
- **削除:**
  - **Deleteキー** を押すと、選択されたノードおよび線が削除されます。

---

## 6. キャンバス操作（パン・ズーム）

### 6.1. パン（移動）

- **操作:**
  - **右クリック＋ドラッグ** により、キャンバス全体を移動できます。
- **効果:**
  - ノードや線の論理座標は変更されず、すべての操作が正しく機能します。

### 6.2. ズーム

- **管理:**
  - ズーム倍率は内部で管理され、ページリロード時に復元されます。
- **備考:**
  - ユーザーが直接操作するための専用 UI は用意されていませんが、状態は保持されます。

---

## 7. 状態管理

- **自動保存:**
  - 各操作完了時に、現在の状態（ノード、線、線種、キャンバスのパン／ズーム状態）がローカルストレージに保存されます。
- **多タブ同期:**
  - 他タブで状態が更新された場合、最新状態に自動的に同期されます。

---

## 8. Undo／Redo 操作

### 8.1. 操作概要

- すべての状態変化（ノードの生成、編集、移動、削除、接続線の生成・変更など）が対象です。
- 各操作完了時に、現在の状態が自動的に内部の Undo スタックに保存されます。

### 8.2. ショートカットキー

- **Undo:**
  - **Windows/Linux:** Ctrl + Z  
  - **Mac:** Command + Z
- **Redo:**
  - **Windows/Linux:** Ctrl + Y  
  - **Mac:** Command + Y

### 8.3. 操作詳細

- **Undo:**  
  直前の操作を取り消し、前の状態に戻ります。
- **Redo:**  
  Undo により取り消された操作を再適用します。

---

## 9. 追加機能: ノード種類変更

- **機能概要:**
  - コントロールパネルの「ノード種類変更」ボタン（`◻︎`）により、選択中のノードの種類を切り替えられます。
  - 複数ノードが選択されている場合、すべてが "text-only" なら "standard" に、そうでなければ "text-only" に変更します。
- **影響:**
  - "text-only" ノードは、背景、枠線、影が排除され、シンプルな見た目となります。
  - 接続線は、"text-only" ノードの場合、ノードの境界との交点に基づいて描画位置が調整されます。

---

## 10. 追加機能: 線種変更

- **機能概要:**
  - コントロールパネルの「線種変更」ボタン（`ー`）により、選択中の線の種類を切り替えられます。
  - 線種は標準矢印→矢印なし→逆矢印→両方向矢印→標準矢印...の順にローテーションします。
- **対応線種:**
  - **standard（標準矢印）:** 終点に矢印がある通常の線
  - **no-arrow（矢印なし）:** 矢印がない単純な線
  - **reverse-arrow（逆矢印）:** 始点に矢印がある線（矢印の向きが反転）
  - **both-arrow（両方向矢印）:** 始点と終点の両方に矢印がある線
- **表示の最適化:**
  - 矢印の位置は自動的に調整され、ノードと重ならないように配置されます。
  - 始点側と終点側の両方で最適な位置に矢印が表示されます。
  - text-only ノードとの接続においても適切な位置に矢印が表示されます。

---

## 付録: マウス操作の仕様一覧

| **操作の種類**              | **対象**     | **開始条件**                                                        | **結果**                                               |
| --------------------------- | ------------ | ------------------------------------------------------------------- | ------------------------------------------------------ |
| クリック（シングル）        | ノード       | 左クリック                                                          | ノードを選択                                          |
| クリック（シングル）        | 線           | 左クリック                                                          | 線を選択（端点ハンドルを表示）                         |
| クリック（シングル）        | 空白         | 左クリック                                                          | 選択が解除される                                      |
| ダブルクリック               | ノード       | 2回目のクリック時にマウスを動かさずに離す                              | ノードが編集モードに入る                               |
| ダブルクリック               | 空白         | 2回目のクリック時にマウスを動かさずに離す                              | 新規ノードが作成される                                |
| ダブルクリック → 移動        | ノード       | 2回目のクリックのマウスボタンを押したまま、一定距離（約10px以上）移動    | ノードから新規線を生成（ブランチ作成モード）             |
| ダブルクリック → 移動        | 空白         | 2回目のクリックのマウスボタンを押したまま、一定距離（約10px以上）移動    | 新規線が作成される                                    |
| ドラッグ（選択なし）        | ノード       | 左クリック＋ドラッグ（一定距離以上）                                   | ノードが移動する                                      |
| ドラッグ（選択なし）        | 線の端点     | 左クリック＋ドラッグ                                                  | 線の端点が移動する                                     |
| ドラッグ（選択なし）        | 空白         | 左クリック＋ドラッグ                                                  | 矩形選択（ラバーバンド選択）が開始される                 |
| ドラッグ（選択あり）        | ノード       | 選択中のノードをドラッグ                                              | 選択中のノードがグループとして移動される               |
| ドラッグ（選択あり）        | 線の端点     | 選択中の線の端点をドラッグ                                             | 選択中の線の端点がグループとして移動される              |
| 右クリック → ドラッグ       | キャンバス   | 右クリック＋ドラッグ                                                  | キャンバスがパン（移動）される                         |
| ボタンクリック              | `◻︎` ボタン    | 左クリック                                                          | 選択中のノードの種類が切り替わる                       |
| ボタンクリック              | `ー` ボタン    | 左クリック                                                          | 選択中の線の種類が切り替わる                          |
| ボタンクリック              | `新規` ボタン    | 左クリック                                                          | すべてのノードと線が削除され、初期状態に戻る           |
| ボタンクリック              | `開く` ボタン    | 左クリック                                                          | ファイル選択ダイアログが表示され、JSONファイルを読み込む |
| ボタンクリック              | `保存` ボタン    | 左クリック                                                          | 現在の状態をJSONファイルとしてダウンロードする         |

---

この仕様書により、ユーザーは直感的な操作（ノードや線の生成・編集・移動、線種変更、グループ選択、パン・ズーム、Undo／Redo）を通じて、柔軟かつ効率的に yaNote を利用できます。